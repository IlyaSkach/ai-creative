# Архитектура ai-creative

## Назначение

Веб-приложение для генерации рекламных креативов по Telegram-каналу: пользователь вставляет ссылку на канал → ИИ анализирует название, описание и посты (за последнюю неделю) → генерирует эксклюзивный креатив со ссылкой на канал. Поддерживаются: выбор «с картинкой / только текст», ручное и ИИ-редактирование, отправка креатива в Telegram.

## Стек

| Компонент        | Технология                          |
|------------------|-------------------------------------|
| Frontend         | React 18, Vite, TypeScript          |
| Backend          | Node.js, Express, TypeScript        |
| Анализ постов    | Парсинг t.me + опционально gramjs   |
| Текст креатива   | DeepSeek API                        |
| Генерация картинки | BotHub API (DALL-E)               |
| Отправка в ТГ    | Telegram Bot API                    |

## Что уже есть у вас

- Токен Telegram-бота
- API DeepSeek
- API BotHub (bothub.chat)

## Что ещё нужно для полного функционала

1. **Анализ постов канала**  
   Стандартный Telegram Bot API не позволяет читать посты канала. Доступны два варианта:
   - **Только t.me**: название и описание канала парсятся со страницы `https://t.me/username` (бота в канал добавлять не нужно). Креатив строится по названию и описанию.
   - **С постами**: нужен Telegram Client (MTProto). В проекте предусмотрен опциональный парсер на **gramjs**: нужны `TELEGRAM_API_ID`, `TELEGRAM_API_HASH` и один раз авторизация (сессия). Тогда приложение сможет заходить в канал и забирать посты за последнюю неделю для глубокого анализа.  
   Или можно поднять отдельный сервис (например ваш **tg-parser**) как HTTP API и вызывать его из ai-creative для получения постов.

2. **Переменные окружения**  
   См. `.env.example`.

## Структура репозитория

```
ai-creative/
├── apps/
│   ├── web/                 # Frontend (React + Vite)
│   │   ├── src/
│   │   │   ├── components/
│   │   │   ├── pages/
│   │   │   ├── api/
│   │   │   └── ...
│   │   └── package.json
│   └── api/                 # Backend (Express)
│       ├── src/
│       │   ├── routes/
│       │   ├── services/
│       │   ├── lib/
│       │   └── ...
│       └── package.json
├── packages/
│   └── channel-parser/      # Парсинг канала (t.me + опционально gramjs)
│       └── src/
├── package.json             # Workspace root
├── ARCHITECTURE.md
├── README.md
└── .env.example
```

## Потоки данных

### 1. Анализ канала

- **Вход**: ссылка на канал (`t.me/username` или `@username`).
- **Шаги**:
  - Извлечение username из ссылки.
  - Загрузка страницы `https://t.me/username`, парсинг og:title, og:description → название, описание.
  - Если настроен Telegram Client (gramjs): получение последних постов за 7 дней (лимит, например 20–50).
- **Выход**: `{ title, description, username, channelLink, posts[] }`.  
  `posts` может быть пустым, если Client не настроен.

### 2. Генерация креатива

- **Вход**: результат анализа канала + флаг `withImage: boolean`.
- **Шаги**:
  - Формирование промпта для DeepSeek: название, описание, тексты постов (если есть). Указание: креатив должен быть эксклюзивным по контенту постов (например «всё про SEO в 2026»), обязательно ссылка на канал.
  - Запрос к DeepSeek → текст креатива (+ опционально `image_prompt` для картинки).
  - Если `withImage`: запрос к BotHub (DALL-E) по `image_prompt` → изображение (base64 или URL).
- **Выход**: `{ text, imageBase64?, imagePrompt? }`.

### 3. Редактирование креатива

- **Вход**: текущий текст (и опционально пожелание пользователя в свободной форме).
- **Режимы**:
  - Ручное: пользователь правит текст в форме.
  - Через ИИ: пользователь пишет, что изменить → запрос к DeepSeek с контекстом текущего текста и инструкцией → новый текст.
- **Выход**: обновлённый текст (и при необходимости перегенерация картинки по новому описанию).

### 4. Отправка в Telegram

- **Вход**: получатель (username или chat_id), финальный текст, опционально картинка.
- **Шаги**: вызов Telegram Bot API (`sendMessage` или `sendPhoto` с caption).
- **Выход**: успех/ошибка.

## API (Backend)

| Метод | Путь | Назначение |
|-------|------|------------|
| POST | `/api/channel/analyze` | Анализ канала по ссылке (t.me + посты при наличии) |
| POST | `/api/creative/generate` | Генерация креатива (текст ± картинка) |
| POST | `/api/creative/edit` | Редактирование текста креатива через ИИ |
| POST | `/api/telegram/send` | Отправка креатива в Telegram (кому указать в теле) |

## Масштабирование

- **Backend**: stateless; можно запускать несколько инстансов за балансировщиком.
- **Парсер постов**: один общий Telegram Client (одна сессия) или вынос в отдельный микросервис (tg-parser как HTTP API) с очередью запросов.
- **Очереди**: при росте нагрузки генерацию креатива и картинки можно вынести в очередь (Bull/Redis), фронт — опрос статуса или WebSocket.
- **Кэш**: кэширование результата анализа канала по `username` на короткий TTL (например 5–15 минут) для повторных запросов без повторного парсинга.
